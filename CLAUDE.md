üéâ CLAUDE CODE: Moonlit Scheduler
üö® Critical Development Policy

No mock data without explicit permission.

Never insert fake IntakeQ IDs, providers, or placeholder database rows.

Data integrity is critical ‚Äî this is a healthcare application.

‚ö†Ô∏è **ALWAYS VERIFY BEFORE MODIFYING DATABASE SCHEMA**

Before adding columns or modifying tables:
1. Create debug API endpoints to verify column existence
2. Use multiple verification methods (direct SELECT, SELECT *, UPDATE attempt)
3. Check related tables for similar columns
4. Document findings in a verification report
5. Get explicit user confirmation before proceeding

**Example verification endpoints:**
- `/api/debug/check-[table]-columns` - Direct column checks
- `/api/debug/search-all-tables-for-columns` - Cross-table searches
- `/api/debug/final-column-verification` - Multi-method verification

This prevents duplicate columns, schema conflicts, and maintains data integrity.

## ‚úÖ COMPLETED: Bookability Trigger Migration (Oct 7, 2025)

**STATUS:** ‚úÖ Fixed "Not bookable for this payer" errors

### What Was Fixed:

**Problem:** Booking trigger used incomplete `bookable_provider_payers_v2` table instead of canonical view, causing "Not bookable for this payer on the selected date" errors for valid supervised appointments.

**Solution:**
- Updated `enforce_bookable_provider_payer()` trigger to use `v_bookable_provider_payer` (canonical view)
- Fixed `appointment_type` and `status` constraint errors in booking flow
- Removed deprecated v2 and v3 bookability tables/views
- Updated IntakeQ API key (rotated Oct 7)

**Result:** ‚úÖ Supervised provider bookings now work (e.g., Dr. Sweeney under Dr. Privratsky's supervision with Molina)

### Migration Files:
- `database-migrations/CONSOLIDATED-bookability-fix.sql` - Trigger update migration
- `database-migrations/005-cleanup-deprecated-bookability-tables.sql` - Cleanup migration
- `BOOKABILITY_MIGRATION_MASTER_PLAN.md` - Complete migration strategy
- `BOOKABILITY_TABLE_AUDIT.md` - Table inventory and analysis

### Supervision Model (Healthcare Billing Context):

**Field Naming Clarification:**
- `billing_provider_id` in database = Actually the **supervising attending** (confusing name)
- For CMS-1500 forms: **Billing Provider** = Moonlit (practice entity), **Rendering Provider** = Attending supervisor

**How Supervised Appointments Work:**
- `provider_id` = Provider patient sees (e.g., Dr. Sweeney - resident)
- `billing_provider_id` = Supervising attending (e.g., Dr. Privratsky)
- `rendering_provider_id` = Also Dr. Privratsky (for insurance claims)
- `network_status` = 'supervised' (vs 'in_network' for direct contracts)

**Example:** Patient books Dr. Sweeney (resident) with Molina ‚Üí Dr. Privratsky supervises and appears as rendering provider on insurance claim ‚Üí Moonlit bills as practice entity.

---

## ‚úÖ COMPLETED: IntakeQ Full Automation Integration (Oct 4-5, 2025)

**STATUS:** ‚ö†Ô∏è Partially working (database booking works, IntakeQ sync has bugs)

### What's Now Live:

**1. IntakeQ Appointment Sync** ‚úÖ
- Join table approach: `provider_intakeq_settings` (Service ID, Location ID, Practitioner ID)
- All bookings automatically sync to IntakeQ Team Calendar
- Google Meet links auto-generated by IntakeQ

**2. Patient Notifications** ‚úÖ
- IntakeQ sends confirmation email with Google Meet link
- IntakeQ sends pre-visit intake questionnaire (ID: `687ad30e356f38c6e4b11e62`)
- Patient receives both automatically after booking

**3. Provider Notifications** ‚úÖ
- Resend email to provider with appointment details
- Includes patient info, appointment time, IntakeQ ID
- Reminds provider to confirm appointment

**4. Admin Notifications** ‚úÖ
- Resend email to hello@trymoonlit.com with booking details
- Includes both Supabase and IntakeQ appointment IDs

**5. Availability Cache Auto-Population** ‚úÖ
- Cache auto-populates when users view calendar dates
- Fixes "DB_INSERT_FAILED" errors for future dates
- Derives from `provider_availability` table (source of truth)
- Uses default service_instance_id: `12191f44-a09c-426f-8e22-0c5b8e57b3b7`

### Key Files Updated:
- `src/lib/services/availabilityCacheService.ts` - Auto-population service
- `src/app/api/patient-booking/merged-availability/route.ts` - Integrated cache auto-population
- `src/app/api/patient-booking/create-appointment-v2/route.ts` - Added provider email field, notifications
- `src/lib/services/emailService.ts` - Enabled provider notifications
- `database-migrations/003-create-provider-intakeq-settings.sql` - Join table migration (‚úÖ deployed)

### Configuration:
- **Service ID:** `137bcec9-6d59-4cd8-910f-a1d9c0616319` (New Patient Visit - insurance UT)
- **Location ID:** `4` (Insurance - UT)
- **Questionnaire ID:** `687ad30e356f38c6e4b11e62` (Pre-visit intake)
- **Resend Domain:** trymoonlit.com (DNS verification pending)

### What Works Now:
‚úÖ Book by date ‚Üí Auto-populates cache ‚Üí Creates appointment ‚Üí Syncs to IntakeQ ‚Üí Sends all emails
‚úÖ Book by provider ‚Üí Same flow
‚úÖ Future dates (Oct 7+) ‚Üí Cache auto-populates on calendar view
‚úÖ All 4 bookable providers configured with IntakeQ settings

### Next Steps (User):
1. ‚úÖ Verify Resend domain DNS records (pending propagation)
2. Once verified, test full booking flow to confirm all emails send

---

üåü Project Status

Moonlit Scheduler = production-ready healthcare website + booking platform

Fully functional booking system (dual intent: Book Now vs See Availability).

Provider directory with real data and filtering.

Double-booking prevention + IntakeQ EMR integration.

Provider auth with admin/provider dual roles.

RLS-compliant schedule management API.

üèóÔ∏è System Architecture

Frontend: Next.js + TypeScript + Tailwind
Backend: Next.js API routes + Supabase Postgres
Auth: Supabase Auth (admin vs provider vs partner separation)
EHRs: IntakeQ + Athena integrations
Email: Resend API (logs to console if unset)

‚úÖ Current Functionality

Website routes:

/ homepage

/book booking flow (?intent=book|explore)

/practitioners searchable provider directory

/ways-to-pay insurance directory

Booking flow: Welcome ‚Üí Insurance ‚Üí Calendar ‚Üí ROI ‚Üí Summary ‚Üí Confirmation

APIs: availability, create appointment, providers-for-payer, ways-to-pay.

Features: real-time conflict checking, language selection, clinical supervision model, exception handling, dual-role login, partner authentication.

Status: All tested and working in production (as of Sept 12, 2025).

üë®‚Äç‚öïÔ∏è Provider/Auth Rules

Dual-role support: e.g. Dr. C. Rufus Sweeney can switch between admin and provider dashboards.

Provider visibility: controlled by list_on_provider_page + is_bookable.

Supervision model: Residents bookable if supervised by attending (billing) provider.

RLS compliance: All provider schedule reads/writes go through admin-privileged API endpoints.

üåü Project Status

Moonlit Scheduler = production-ready healthcare website + booking platform

Fully functional booking system (dual intent: Book Now vs See Availability).

Provider directory with real data and filtering.

Double-booking prevention + IntakeQ EMR integration.

Provider auth with admin/provider dual roles.

RLS-compliant schedule management API.

üèóÔ∏è System Architecture

Frontend: Next.js + TypeScript + Tailwind
Backend: Next.js API routes + Supabase Postgres
Auth: Supabase Auth (admin vs provider vs partner separation)
EHRs: IntakeQ + Athena integrations
Email: Resend API (logs to console if unset)

‚úÖ Current Functionality

Website routes:

/ homepage

/book booking flow (?intent=book|explore)

/practitioners searchable provider directory

/ways-to-pay insurance directory

Booking flow: Welcome ‚Üí Insurance ‚Üí Calendar ‚Üí ROI ‚Üí Summary ‚Üí Confirmation

APIs: availability, create appointment, providers-for-payer, ways-to-pay.

Features: real-time conflict checking, language selection, clinical supervision model, exception handling, dual-role login, partner authentication.

Status: All tested and working in production (as of Sept 12, 2025).

üë®‚Äç‚öïÔ∏è Provider/Auth Rules

Dual-role support: e.g. Dr. C. Rufus Sweeney can switch between admin and provider dashboards.

Provider visibility: controlled by list_on_provider_page + is_bookable.

Supervision model: Residents bookable if supervised by attending (billing) provider.

RLS compliance: All provider schedule reads/writes go through admin-privileged API endpoints.

üîß Development Setup
# Install dependencies
npm install

# Env vars (.env.local)
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_KEY=...
INTAKEQ_API_KEY=...
RESEND_API_KEY=...

# Run locally
npm run dev


Always test locally before pushing (main auto-deploys).

Verify booking flow end-to-end on desktop + mobile.

üõ†Ô∏è Common Tasks

Add EMR: create src/lib/services/[emr]Service.ts, update booking routes.

Emails: edit src/lib/services/emailService.ts.

Booking flow: modify src/components/booking/BookingFlow.tsx.

Admin/provider auth: see auth_profiles + app_users tables.

üîç Troubleshooting

Welcome page buttons unclickable ‚Üí clear .next + node_modules/.cache.

No availability ‚Üí check provider_availability_cache, providers, payers.

Double-booking ‚Üí validate IntakeQ IDs + conflict logic.

Appointments missing in IntakeQ ‚Üí confirm API key + practitioner mapping.

Email not sending ‚Üí check RESEND_API_KEY, otherwise see console logs.

**üö® RECURRING BUG: startDateTime Validation Errors - PERMANENTLY FIXED**

**Symptoms**: Console errors like `Invalid startDateTime: "09:00" "from slot:" {}`

**Root Cause**: The validateAndNormalizeData function in mapApiSlotToTimeSlot expected arrays but received individual objects, causing data corruption that resulted in empty objects `{}` being passed to fallback functions.

**Why it kept recurring**: Previous Claude instances tried to fix validation schemas instead of removing the problematic validation layer entirely.

**PERMANENT SOLUTION IMPLEMENTED**:
- Removed validateAndNormalizeData from mapApiSlotToTimeSlot in dataValidation.ts:160
- Implemented direct field mapping that handles the actual API response format
- Added clear documentation explaining why validation was removed
- This approach eliminates the data corruption that caused the errors

**NEVER**: Re-add validation to mapApiSlotToTimeSlot - it causes more problems than it solves

üìä Monitoring

Audit API logs for 409 conflicts (double-booking prevention).

Track appointment creation rate in appointments table.

Use debug endpoints (/api/debug/...) for provider-payer relationships, availability, and bookability explanations.

üìù For Future Developers

Use canonical view v_bookable_provider_payer for provider-payer relationships.

Avoid direct Supabase client calls from frontend for protected tables ‚Üí always use API endpoints.

Keep role separation clear: admin, provider, partner each have distinct routes and dashboards.

All production data must be real; confirm with Miriam before seeding.

Last updated: Oct 5, 2025
